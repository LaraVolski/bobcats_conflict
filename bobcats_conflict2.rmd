---
title: "bobcats_conflict2"
author: "Lara Volski"
date: "2022-07-09"
output: html_document
---
---
title: "bobcats_conflict"
author: "Lara Volski"
date: "2022-07-10"
output: html_document
---

# Part 1) Setting up

### 1.1 Load Packages
```{r library.packages, include = FALSE}
library(nlme)
library(ggplot2)
library(camtrapR)
library(dplyr)
library(tidyverse)
library(plyr)
library(plotrix)
library(here)
library(MASS)
library(lme4)
library(car)
```

### 1.2 Read in CSVs
```{r csvs}
# first the record tables
record.table.phase1 <- read.csv("recordtable_phase1_15min.csv")
record.table.phase2 <- read.csv("recordtable_phase2_15min.csv")
record.table.phase3 <- read.csv("recordtable_phase3_15min.csv")
record.table.phase4 <- read.csv("recordtable_phase4_15min.csv")
#correct phase dates
record.table.phase1$Date <- format(as.Date(record.table.phase1$Date), "%m-%d-%Y")
record.table.phase2$Date <- format(as.Date(record.table.phase2$Date), "%m-%d-%Y")
record.table.phase3$Date <- format(as.Date(record.table.phase3$Date), "%m-%d-%Y")
record.table.phase4$Date <- format(as.Date(record.table.phase4$Date), "%m-%d-%Y")

# combine record tables
record.table.all <- bind_rows(record.table.phase1, record.table.phase2, record.table.phase3, record.table.phase4)
record.table.all$Date <- format(as.Date(as.character(record.table.all$Date), "%m-%d-%Y"))

# import camera phase operation dates
cam.operation.all.phases <- read.csv("camera_operation_all_phases1234.csv", header=T)
# reading in metadata
metadata <- read.csv("camera_metadata_rasters.csv", header=T)
```

### Create a Camera Operation Matrix
```{r camera.operation.matrix}
# generate camera operation matrix
camera.operation.matrix <- cameraOperation(CTtable = cam.operation.all.phases,
                                           stationCol = "Camera",
                                           setupCol = "Start",
                                           retrievalCol = "End",
                                           dateFormat = "%m/%d/%Y",
                                           hasProblems = TRUE,
                                           writecsv = FALSE)
# Turn matrix into a dataframe
camera.operation.matrix <- rownames_to_column(as.data.frame(camera.operation.matrix), var = "Camera")
```

### Create a Classification Table
```{r define unique classifications}
# Define unique classification categories. We will need this later to ensure these columns are present in all tables. This list should be mutually exclusive with the species excluded above (probably a neater way to have done this, but can cross-check using 'unique' function).
# define list of all classification columns that we want 
allclassifications <- c(Bobcat = NA_real_, Coyote = NA_real_, Deer_Doe = NA_real_,
                        Deer_Other = NA_real_, Deer_Fawn = NA_real_, Deer_Buck_Legal = NA_real_,
                        Deer_Buck_Spike = NA_real_, Deer_Buck_Young_Button = NA_real_,
                        Deer_Buck_Antlerless = NA_real_, Squirrel = NA_real_, Fox = NA_real_, 
                        Skunk = NA_real_, Bear = NA_real_, Mountain_Lion = NA_real_, Raccoon = NA_real_,
                        Jack_Rabbit = NA_real_, Dog = NA_real_, Sheep = NA_real_, Pig = NA_real_,
                        Deer_Buck = NA_real_, Deer = NA_real_)  
# double check (here, there are 21 unique classifications)
length(allclassifications)
unique(record.table.all$Classification)
```

### Kaitlyn's RAI Code
```{r}
## RAI calculation
#### Define rai.calculate function
# Create function that takes an operation matrix and record table and calculates RAI for dates of interest.
#For this function to work, the record table must have a column called "Date" and it should have dates formatted as YYYY-MM-DD. The start and end date should be character strings formatted as "YYYY-MM-DD".
rai.calculate <- function(record.table, start.date, end.date, camop, timeperiod.name) {
  # define names to use in file names (just removes the dashes)
  start.name <- gsub("-", "", start.date)
  end.name <- gsub("-", "", end.date)
  
  # calculate how long the camera was functioning in that time period
    
    # selects columns within specified dates
    camop.subset <- dplyr::select(camop, Camera, start.date:end.date) 
    
    # sum rows within specified dates (there are 1s when camera was operating, NA when not)
    camop.subset$Operation <- rowSums(dplyr::select(camop.subset, start.date:end.date), na.rm=TRUE) 
    
    # get rid of the individual day columns, just select Camera, Operation
    camop.subset <- dplyr::select(camop.subset, Camera, Operation)
    
  # format start and end dates as dates
  start.date <- as.Date(start.date)
  end.date <- as.Date(end.date)
  
  # subset record table to date of interest
  record.table.subset <- record.table[record.table$Date >= start.date & record.table$Date <= end.date,]
  
  # calculate number of observations of each classification type at each camera
  records <- record.table.subset %>%
      dplyr::group_by(Classification, Camera) %>%
      dplyr::summarise(Detections = n()) %>%     # counts number of observations of each species
      spread(key = Classification, value = Detections)  # gets from long to wide format  
  
  # add columns for classes not present
  records <- add_column(records, !!!allclassifications[!names(allclassifications) %in% names(records)])
  
  # gather data so each class-camera is its own row again
  records <- records %>% gather(2:ncol(records), key = "Class", value = "Count")
  
  # replace NA with 0 
  records[is.na(records)] <- 0
  
  # join camera operation dates and observations
  RAI.table <- plyr::join(records, camop.subset)
  
  # calculate RAI
  RAI.table$RAI <- RAI.table$Count / RAI.table$Operation
  
  # add new column for time period
  RAI.table$TimePeriod <- timeperiod.name
  
  # write csv
  write.csv(RAI.table, file = paste("RAI_", timeperiod.name, "_", start.name, "_", end.name, ".csv", collapse = "", sep = ""),row.names=F)
    
  return(RAI.table)
  
}
``` 

#### The RAI function in action
Here is an example of the RAI function in action
```{r calculate RAI, message = F}
april.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-04-01", end.date = "2016-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2016")
may.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-05-01", end.date = "2016-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2016")
june.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-06-01", end.date = "2016-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2016")
july.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-07-01", end.date = "2016-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2016")
august.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-08-01", end.date = "2016-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2016")
september.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-09-01", end.date = "2016-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2016")
october.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-10-01", end.date = "2016-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2016")
november.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-11-01", end.date = "2016-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2016")
december.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-12-01", end.date = "2016-12-31", camop = camera.operation.matrix, timeperiod.name = "december.2016")
january.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-01-01", end.date = "2017-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2017")
february.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-02-01", end.date = "2017-02-28", camop = camera.operation.matrix, timeperiod.name = "february.2017")
march.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-03-01", end.date = "2017-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2017")
april.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-04-01", end.date = "2017-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2017")
may.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-05-01", end.date = "2017-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2017")
june.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-06-01", end.date = "2017-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2017")
july.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-07-01", end.date = "2017-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2017")
august.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-08-01", end.date = "2017-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2017")
september.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-09-01", end.date = "2017-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2017")
october.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-10-01", end.date = "2017-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2017")
november.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-11-01", end.date = "2017-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2017")
december.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-12-01", end.date = "2017-12-31", camop = camera.operation.matrix, timeperiod.name = "december.2017")
january.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-01-01", end.date = "2018-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2018")
february.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-02-01", end.date = "2018-02-28", camop = camera.operation.matrix, timeperiod.name = "february.2018")
march.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-03-01", end.date = "2018-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2018")
april.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-04-01", end.date = "2018-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2018")
may.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-05-01", end.date = "2018-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2018")
june.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-06-01", end.date = "2018-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2018")
july.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-07-01", end.date = "2018-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2018")
august.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-08-01", end.date = "2018-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2018")
september.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-09-01", end.date = "2018-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2018")
october.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-10-01", end.date = "2018-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2018")
november.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-11-01", end.date = "2018-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2018")
december.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-03-01", end.date = "2018-03-31", camop = camera.operation.matrix, timeperiod.name = "december.2018")
january.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-01-01", end.date = "2019-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2019")
february.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-02-01", end.date = "2019-02-28", camop = camera.operation.matrix, timeperiod.name = "february.2019")
march.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-03-01", end.date = "2019-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2019")
april.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-04-01", end.date = "2019-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2019")
may.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-05-01", end.date = "2019-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2019")
june.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-06-01", end.date = "2019-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2019")
july.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-07-01", end.date = "2019-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2019")
august.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-08-01", end.date = "2019-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2019")
september.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-09-01", end.date = "2019-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2019")
october.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-10-01", end.date = "2019-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2019")
november.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-11-01", end.date = "2019-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2019")
december.2019 <- rai.calculate(record.table = record.table.all, start.date = "2019-03-01", end.date = "2019-03-31", camop = camera.operation.matrix, timeperiod.name = "december.2019")
january.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-01-01", end.date = "2020-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2020")
february.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-02-01", end.date = "2020-02-28", camop = camera.operation.matrix, timeperiod.name = "february.2020")
march.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-03-01", end.date = "2020-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2020")
april.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-04-01", end.date = "2020-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2020")
may.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-05-01", end.date = "2020-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2020")
june.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-06-01", end.date = "2020-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2020")
july.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-07-01", end.date = "2020-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2020")
august.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-08-01", end.date = "2020-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2020")
september.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-09-01", end.date = "2020-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2020")
october.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-10-01", end.date = "2020-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2020")
november.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-11-01", end.date = "2020-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2020")
december.2020 <- rai.calculate(record.table = record.table.all, start.date = "2020-12-01", end.date = "2020-12-31", camop = camera.operation.matrix, timeperiod.name = "december.2020")
january.2021 <- rai.calculate(record.table = record.table.all, start.date = "2021-01-01", end.date = "2021-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2021")
february.2021 <- rai.calculate(record.table = record.table.all, start.date = "2021-02-01", end.date = "2021-02-28", camop = camera.operation.matrix, timeperiod.name = "february.2021")
march.2021 <- rai.calculate(record.table = record.table.all, start.date = "2021-03-01", end.date = "2021-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2021")
```

#### Combine RAI across seasons

# Combine these before, during, and after hunt periods back together into a single data frame and add a column corresponding to the hunt period. 

```{r RAI combine}
# combine different RAI files
all.rai <- rbind(april.2016, may.2016, june.2016, july.2016, august.2016, september.2016, october.2016, november.2016, december.2016, january.2017, february.2017, march.2017, april.2017, may.2017, june.2017, july.2017, august.2017, september.2017, october.2017, november.2017, december.2017, january.2018, february.2018, march.2018, april.2018, may.2018, june.2018, july.2018, august.2018, september.2018, october.2018, november.2018, december.2018, january.2019, february.2019, march.2019, april.2019, may.2019, june.2019, july.2019, august.2019, september.2019, october.2019, november.2019, december.2019, january.2020, february.2020, march.2020, april.2020, may.2020, june.2020, july.2020, august.2020, september.2020, october.2020, november.2020, december.2020, january.2021, february.2021, march.2021)

# add column for time period relative to month
all.rai$month <- NA
for (i in 1:nrow(all.rai)) {
  if (all.rai$TimePeriod[i] == "april.2016" | all.rai$TimePeriod[i] == "may.2016") {
    all.rai$month[i] <- "April2016"
  }
  if (all.rai$TimePeriod[i] == "may.2016" | all.rai$TimePeriod[i] == "june.2016" ) {
    all.rai$month[i] <- "May2016"
  }
   if (all.rai$TimePeriod[i] == "june.2016" | all.rai$TimePeriod[i] == "july.2016" ) {
    all.rai$month[i] <- "June2016"
  }
  if (all.rai$TimePeriod[i] == "july.2016" | all.rai$TimePeriod[i] == "august.2016" ) {
    all.rai$month[i] <- "July2016"
  }
  if (all.rai$TimePeriod[i] == "august.2016" | all.rai$TimePeriod[i] == "september.2016" ) {
    all.rai$month[i] <- "August2016"
  }
  if (all.rai$TimePeriod[i] == "september.2016" | all.rai$TimePeriod[i] == "october.2016" ) {
    all.rai$month[i] <- "September2016"
  }
  if (all.rai$TimePeriod[i] == "october.2016" | all.rai$TimePeriod[i] == "november.2016" ) {
    all.rai$month[i] <- "October2016"
  }
  if (all.rai$TimePeriod[i] == "november.2016" | all.rai$TimePeriod[i] == "december.2016" ) {
    all.rai$month[i] <- "November2016"
  }
  if (all.rai$TimePeriod[i] == "december.2016" | all.rai$TimePeriod[i] == "january.2017" ) {
    all.rai$month[i] <- "December2016"
  }
  if (all.rai$TimePeriod[i] == "january.2017" | all.rai$TimePeriod[i] == "february.2017" ) {
    all.rai$month[i] <- "January2017"
  }
  if (all.rai$TimePeriod[i] == "february.2017" | all.rai$TimePeriod[i] == "march.2017" ) {
    all.rai$month[i] <- "February2017"
  }
  if (all.rai$TimePeriod[i] == "march.2017" | all.rai$TimePeriod[i] == "april.2017" ) {
    all.rai$month[i] <- "March2017"
  }
  if (all.rai$TimePeriod[i] == "april.2017" | all.rai$TimePeriod[i] == "may.2017" ) {
    all.rai$month[i] <- "April2017"
  }
  if (all.rai$TimePeriod[i] == "may.2017" | all.rai$TimePeriod[i] == "june.2017" ) {
    all.rai$month[i] <- "May2017"
  }
  if (all.rai$TimePeriod[i] == "june.2017" | all.rai$TimePeriod[i] == "july.2017" ) {
    all.rai$month[i] <- "June2017"
  }
  if (all.rai$TimePeriod[i] == "july.2017" | all.rai$TimePeriod[i] == "august.2017" ) {
    all.rai$month[i] <- "July2017"
  }
  if (all.rai$TimePeriod[i] == "august.2017" | all.rai$TimePeriod[i] == "september.2017" ) {
    all.rai$month[i] <- "August2017"
  }
  if (all.rai$TimePeriod[i] == "september.2017" | all.rai$TimePeriod[i] == "october.2017" ) {
    all.rai$month[i] <- "September2017"
  }
  if (all.rai$TimePeriod[i] == "october.2017" | all.rai$TimePeriod[i] == "november.2017" ) {
    all.rai$month[i] <- "October2017"
  }
  if (all.rai$TimePeriod[i] == "november.2017" | all.rai$TimePeriod[i] == "december.2017" ) {
    all.rai$month[i] <- "November2017"
  }
  if (all.rai$TimePeriod[i] == "december.2017" | all.rai$TimePeriod[i] == "january.2018" ) {
    all.rai$month[i] <- "December2017"
  }
  if (all.rai$TimePeriod[i] == "january.2018" | all.rai$TimePeriod[i] == "february.2018" ) {
    all.rai$month[i] <- "January2018"
  }
  if (all.rai$TimePeriod[i] == "february.2018" | all.rai$TimePeriod[i] == "march.2018" ) {
    all.rai$month[i] <- "February2018"
  }
  if (all.rai$TimePeriod[i] == "march.2018" | all.rai$TimePeriod[i] == "april.2018" ) {
    all.rai$month[i] <- "March2018"
  }
  if (all.rai$TimePeriod[i] == "april.2018" | all.rai$TimePeriod[i] == "may.2018" ) {
    all.rai$month[i] <- "April2018"
  }
  if (all.rai$TimePeriod[i] == "may.2018" | all.rai$TimePeriod[i] == "june.2018" ) {
    all.rai$month[i] <- "May2018"
  }
  if (all.rai$TimePeriod[i] == "june.2018" | all.rai$TimePeriod[i] == "july.2018" ) {
    all.rai$month[i] <- "June2018"
  }
  if (all.rai$TimePeriod[i] == "july.2018" | all.rai$TimePeriod[i] == "august.2018" ) {
    all.rai$month[i] <- "July2018"
  }
  if (all.rai$TimePeriod[i] == "august.2018" | all.rai$TimePeriod[i] == "september.2018" ) {
    all.rai$month[i] <- "August2018"
  }
  if (all.rai$TimePeriod[i] == "september.2018" | all.rai$TimePeriod[i] == "october.2018" ) {
    all.rai$month[i] <- "September2018"
  }
  if (all.rai$TimePeriod[i] == "october.2018" | all.rai$TimePeriod[i] == "november.2018" ) {
    all.rai$month[i] <- "October2018"
  }
  if (all.rai$TimePeriod[i] == "november.2018" | all.rai$TimePeriod[i] == "december.2018" ) {
    all.rai$month[i] <- "November2018"
  }
  if (all.rai$TimePeriod[i] == "december.2018" | all.rai$TimePeriod[i] == "january.2019" ) {
    all.rai$month[i] <- "December2018"
  }
  if (all.rai$TimePeriod[i] == "january.2019" | all.rai$TimePeriod[i] == "february.2019" ) {
    all.rai$month[i] <- "January2019"
  }
  if (all.rai$TimePeriod[i] == "february.2019" | all.rai$TimePeriod[i] == "march.2019") {
    all.rai$month[i] <- "February2019"
  }
  if (all.rai$TimePeriod[i] == "march.2019" | all.rai$TimePeriod[i] == "april.2019" ) {
    all.rai$month[i] <- "March2019"
  }
  if (all.rai$TimePeriod[i] == "april.2019" | all.rai$TimePeriod[i] == "may.2019" ) {
    all.rai$month[i] <- "April2019"
  }
  if (all.rai$TimePeriod[i] == "may.2019" | all.rai$TimePeriod[i] == "june.2019" ) {
    all.rai$month[i] <- "May2019"
  }
   if (all.rai$TimePeriod[i] == "june.2019" | all.rai$TimePeriod[i] == "july.2019" ) {
    all.rai$month[i] <- "June2019"
  }
  if (all.rai$TimePeriod[i] == "july.2019" | all.rai$TimePeriod[i] == "august.2019" ) {
    all.rai$month[i] <- "July2019"
  }
  if (all.rai$TimePeriod[i] == "august.2019" | all.rai$TimePeriod[i] == "september.2019" ) {
    all.rai$month[i] <- "August2019"
  }
  if (all.rai$TimePeriod[i] == "september.2019" | all.rai$TimePeriod[i] == "october.2019" ) {
    all.rai$month[i] <- "September2019"
  }
  if (all.rai$TimePeriod[i] == "october.2019" | all.rai$TimePeriod[i] == "november.2019" ) {
    all.rai$month[i] <- "October2019"
  }
  if (all.rai$TimePeriod[i] == "november.2019" | all.rai$TimePeriod[i] == "december.2019" ) {
    all.rai$month[i] <- "November2019"
  }
  if (all.rai$TimePeriod[i] == "december.2019" | all.rai$TimePeriod[i] == "january.2020" ) {
    all.rai$month[i] <- "December2019"
  }
  if (all.rai$TimePeriod[i] == "january.2020" | all.rai$TimePeriod[i] == "february.2020" ) {
    all.rai$month[i] <- "January2020"
  }
  if (all.rai$TimePeriod[i] == "february.2020" | all.rai$TimePeriod[i] == "march.2020") {
    all.rai$month[i] <- "February2020"
  }
  if (all.rai$TimePeriod[i] == "march.2020" | all.rai$TimePeriod[i] == "april.2020" ) {
    all.rai$month[i] <- "March2020"
  }
  if (all.rai$TimePeriod[i] == "april.2020" | all.rai$TimePeriod[i] == "may.2020" ) {
    all.rai$month[i] <- "April2020"
  }
  if (all.rai$TimePeriod[i] == "may.2020" | all.rai$TimePeriod[i] == "june.2020" ) {
    all.rai$month[i] <- "May2020"
  }
   if (all.rai$TimePeriod[i] == "june.2020" | all.rai$TimePeriod[i] == "july.2020" ) {
    all.rai$month[i] <- "June2020"
  }
  if (all.rai$TimePeriod[i] == "july.2020" | all.rai$TimePeriod[i] == "august.2020" ) {
    all.rai$month[i] <- "July2020"
  }
  if (all.rai$TimePeriod[i] == "august.2020" | all.rai$TimePeriod[i] == "september.2020" ) {
    all.rai$month[i] <- "August2020"
  }
  if (all.rai$TimePeriod[i] == "september.2020" | all.rai$TimePeriod[i] == "october.2020" ) {
    all.rai$month[i] <- "September2020"
  }
  if (all.rai$TimePeriod[i] == "october.2020" | all.rai$TimePeriod[i] == "november.2020" ) {
    all.rai$month[i] <- "October2020"
  }
  if (all.rai$TimePeriod[i] == "november.2020" | all.rai$TimePeriod[i] == "december.2020" ) {
    all.rai$month[i] <- "November2020"
  }
  if (all.rai$TimePeriod[i] == "december.2020" | all.rai$TimePeriod[i] == "january.2021" ) {
    all.rai$month[i] <- "December2020"
  }
  if (all.rai$TimePeriod[i] == "january.2021" | all.rai$TimePeriod[i] == "february.2021" ) {
    all.rai$month[i] <- "January2021"
  }
  if (all.rai$TimePeriod[i] == "february.2021" | all.rai$TimePeriod[i] == "march.2021" ) {
    all.rai$month[i] <- "February2021"
  }
  if (all.rai$TimePeriod[i] == "march.2021" | all.rai$TimePeriod[i] == "april.2021" ) {
    all.rai$month[i] <- "March2021"
  }
}
# specify the factor level (so they plot in this order)
all.rai$month <- fct_relevel(all.rai$month, "April2016", "May2016", "June2016", "July2016", "August2016", "September2016", "October2016", "November2016", "December2016", "January2017", "February2017", "March2017", "April2017", "May2017", "June2017", "July2017", "August2017", "September2017", "October2017", "November2017", "December2017", "January2018", "February2018", "March2018", "April2018", "May2018", "June2018", "July2018", "August2018", "September2018", "October2018", "November2018", "December2018", "January2019", "February2019", "March2019", "April2019", "May2019", "June2019", "July2019", "August2019", "September2019", "October2019", "November2019", "December2019", "January2020", "February2020", "March2020", "April2020", "May2020", "June2020", "July2020", "August2020", "September2020", "October2020", "November2020", "December2020", "January2021", "February2021", "March2021")
# convert RAI to log scale, but first add 1 to everything so that 0s can be transformed
all.rai$RAI.log <- log(all.rai$RAI + 1)
# also apply square root transformation, to see if that changes anything
all.rai$RAI.sqrt <- sqrt(all.rai$RAI)
```

For cameras that were operating for fewer than 10 days, I change the RAI to NA, because I don't want to calculate RAI based on so few trap-nights.

```{r RAI clean}
# for cameras that were operating <10 days, change Count and RAI to NA
for (i in 1:nrow(all.rai)) {
  if(all.rai$Operation[i] < 10) {
    all.rai$Count[i] <- NA
    all.rai$RAI[i] <- NA
    all.rai$RAI.log[i] <- NA
  } 
}
```

Calculate mean, SD, and standard error of RAI for each species/class (across cameras), with one row per species/class. Not actually using this for anything yet... code's here if need be. This particular approach isn't very good since it counts each camera 6 times (once per year-season).
```{r summarize class RAI}
# note that for species-camera pairs where there were no detections, the row is missing (rather than NA)
rai.class.summary <- all.rai %>%
  dplyr::group_by(Class, TimePeriod) %>%
  dplyr::summarise(RAI.mean = mean(RAI, na.rm=T), 
                   RAI.sd = sd(RAI, na.rm=T), 
                   RAI.se = std.error(RAI, na.rm=T))
```
### Convert RAI table from long to wide

Reshape the RAI table to combine records and operation dates, and recalculate overall RAI for the periods before, during, and after the hunt. Then spread so that there are columns for each class RAI before, during, and after hunt, with one row for each camera.
```{r long to wide}
# summarize count and operation dates for before/during/after (combine 2016 and 2017 records)
rai.summarized <- subset(all.rai, Class = c("Bobcat", "Dog", "Sheep")) %>%
  dplyr::group_by(Camera, Class, month) %>%
  dplyr::summarise(Operation = sum(Operation, na.rm=T), 
                   Count = sum(Count, na.rm=T))
# recalculate RAI for each species-period
rai.summarized$RAI <- rai.summarized$Count / rai.summarized$Operation
# recalculate log RAI for each species-period
rai.summarized$RAI.log <- log(rai.summarized$RAI + 1)
# and recalculate square root of RAI for each species-period
rai.summarized$RAI.sqrt <- sqrt(rai.summarized$RAI + 1)
# combine species and season into new column to use as key
rai.summarized$Class_month <- paste(rai.summarized$Class, "_", rai.summarized$month, sep = "")
# take just columns with camera, RAI, and key
rai.wide <- rai.summarized[,c(1,6,9)]
# spread so each class and season RAI (before, during, after hunt) is in its own column
rai.wide <- tidyr::spread(rai.wide, key = Class_month, value = RAI)
# take just columns with camera, RAI.log, and key
rai.wide.log <- rai.summarized[,c(1,7,9)]
# spread so each class and season log RAI (before, during, after hunt) is in its own column
rai.wide.log <- tidyr::spread(rai.wide.log, key = Class_month, value = RAI.log)
# take just columns with camera, RAI.sqrt, and key
rai.wide.sqrt <- rai.summarized[,c(1,8,9)]
# spread so each class and season sqrt RAI (before, during, after hunt) is in its own column
rai.wide.sqrt <- tidyr::spread(rai.wide.sqrt, key = Class_month, value = RAI.sqrt)
```
Merge camera metadata with RAI.

```{r merge metadata with RAI, message = F}
covariates <- read.csv(file = here::here('C:/Users/lavol/Documents/bobcats_conflict/bobcats_conflict', 'camera_metadata_rasters.csv'))
# merge all of these with covariates
rai.summarized <- merge(rai.summarized, covariates)
rai.wide <- merge(rai.wide, covariates)
rai.wide.log <- merge(rai.wide.log, covariates)
all.rai <- plyr::join(all.rai, covariates)
```

# Part 2) Determining baseline bobcat activity
```{r}
subset.rai <- read.csv("subset.rai.csv")

# Total number of bobcat detections
x <- subset(all.rai, Class == "Bobcat")$Count
sum(x, na.rm = TRUE) # Sum is 698 bobcats

# Examining Seasonality
ggplot(subset.rai, aes(x = Season, y = Bobcat_RAI, fill = Season)) +
  geom_col() +
  labs(x ="Seasonal", y = "Relative Bobcat Activity")

# Bobcat Diel Activity Pattern -- need to get code

# Examining environmental variables

##rugged81.clean
ggplot(subset.rai, aes(x = rugged81.clean, y = Bobcat_RAI)) +
  geom_smooth(method = lm)

##rugged121.clean
ggplot(subset.rai, aes(x = rugged121.clean, y = Bobcat_RAI)) +
  geom_smooth(method = lm)

##road.dist.clean
ggplot(subset.rai, aes(x = road.dist.clean, y = Bobcat_RAI)) +
  geom_smooth(method = lm)

#elevation.clean
ggplot(subset.rai, aes(x = elevation.clean, y = Bobcat_RAI)) +
  geom_smooth(method = lm)

#slope.clean
ggplot(subset.rai, aes(x = slope.clean, y = Bobcat_RAI)) +
  geom_smooth(method = lm)

#vegetation.coarser.clean (discrete!)
ggplot(subset.rai, aes(x = vegetation.coarser.clean, y = Bobcat_RAI)) +
  geom_bar(stat = "identity")


## Graph Bobcat RAI by Sheep Presence
ggplot(subset.rai, aes(x = Sheep, y = Bobcat_RAI, fill = Sheep)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("No", "Yes")) +
  scale_y_log10() +
  labs(x ="Sheep Present", y = "Relative Bobcat Activity (detections/month)") +
  scale_fill_manual(values=c("cadetblue4", "orange1"))

## Graph Bobcat RAI by Sheep Presence and Fire
bobcat.rai.fire <- read.csv("subset.rai.oneyearbeforeandafterfire.csv")

ggplot(bobcat.rai.fire, aes(x = Sheep, y = Bobcat_RAI, fill = Sheep)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("Ungrazed", "Grazed")) +
  scale_y_log10() +
  facet_wrap(~ Fire) +
  labs(x ="Before and After Fire", y = "Relative Bobcat Activity (detections/month)") +
  scale_fill_manual(values=c("cadetblue4", "orange1")) 
  ggsave(file = "bobcat.rai.by.fire.and.sheep.png")

```

# Part 3) Determining the impact of Foxlights on Bobcat Activity
```{r}
rai_bobcat_lv <- read.csv("rai_bobcat_lv.csv")

# Bobcat activity with and without the presence of Foxlights
ggplot(rai_bobcat_lv, aes(x = Foxlight, y = RAI*35, fill = Foxlight)) +
  geom_boxplot(alpha=2) +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("No", "Yes")) +
 # geom_jitter() +
  labs(x ="Foxlight", y = "Relative Bobcat Activity (detections/phase)") +
  ## scale_y_continuous(labels = mult_format()) +
  scale_fill_manual(values=c("cadetblue4", "orange1"))

# Bobcats and habituation
habituation.by.rai.foxY <- read.csv("lyru.habituation.foxlights.csv", header=T)

ggplot(habituation.by.rai.foxY, aes(x = Phase, y = LYRU.RAI)) +
  geom_boxplot(fill = "cadetblue4") +
  labs(title = "Bobcat Acivity by Active Foxlight Phase",
       x = "First, Second, Third, Fourth, or Fifth Time a Foxlight was Active at a Site", y = "Bobcat RAI")

medians.by.week <- read.csv("lyru.medians.csv", header=T)
ggplot(data = medians.by.week, aes(x = Week, y = Median, fill = Foxlight)) +
  geom_bar(stat = "identity", position = position_dodge())  +
  scale_x_continuous(breaks = seq(1, 9, by = 1)) +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.title = element_text(face="bold", size = 10)) +
labs(x ="Week", y = "Median Bobcat Detections") +
  scale_fill_manual(values=c("cadetblue4", "orange1")) + 
  theme_bw()

# Bobcat Diel Patterns (in other R project)

# Bobcat Env Variables
ggplot(rai_bobcat_lv, aes(x = Rugged.121, y = RAI)) +
  geom_smooth(method = lm)

ggplot(rai_bobcat_lv, aes(x = Elevation, y = RAI)) +
  geom_smooth(method = lm) 

ggplot(rai_bobcat_lv, aes(x = road.dist.clean, y = RAI)) +
  geom_smooth(method = lm) 

ggplot(rai_bobcat_lv, aes(x = Slope, y = RAI)) +
  geom_smooth(method = lm)

histogram(RAI, data = rai_bobcat_lv)

```


# Part 4) Determining the impact of LGDs on Bobcat Activity

## Question 1: How do bobcat detections vary by LGD presence?
```{r}

# Dog (Y/N) and Bobcat RAI using Grid Camera Survey Data
ggplot(subset.rai, aes(x = Dog, y = Bobcat_RAI, fill = Dog)) +
  geom_boxplot(alpha=2) +
  scale_x_discrete(labels = c("No", "Yes")) +
  labs(x ="Livestock Guardian Dog Presence", y = "Relative Bobcat Activity (detections/month)") +
  scale_fill_manual(values=c("cadetblue4", "orange1")) 
ggsave("dog.and.bobcat.rai.boxplot.png")

# Sheep (Y/N) and Bobcat RAI using Grid Camera Survey Data
ggplot(subset.rai, aes(x = Sheep, y = Bobcat_RAI, fill = Sheep)) +
  geom_boxplot(alpha=2) +
  scale_x_discrete(labels = c("No", "Yes")) +
  labs(x ="Sheep Presence", y = "Relative Bobcat Activity (detections/month)") +
  scale_fill_manual(values=c("cadetblue4", "orange1")) 
ggsave("sheeo.and.bobcat.rai.boxplot.lgd.png")

# Sheep (Y/N) and Bobcat RAI using Foxlight Data
ggplot(rai_bobcat_lv, aes(x = Sheep_Presence, y = RAI, fill = Sheep_Presence)) +
  geom_boxplot(alpha=2) +
  scale_x_discrete(labels = c("No", "Yes")) +
  labs(x ="Sheep Presence", y = "Relative Bobcat Activity (detections/month)") +
  scale_fill_manual(values=c("cadetblue4", "orange1")) 
ggsave("sheeo.and.bobcat.rai.boxplot.foxlights.png")

# Individual Dog Count using Grid Camera Survey data
ggplot(data = subset.rai, aes(x = Individual_Dog, y = Bobcat_RAI)) +
  geom_smooth(method="loess", se=F) +
  geom_point() +
  labs(x ="Dogs", y = "Bobcat RAI")
ggsave("indv.dog.geomsmooth.lgd.png")

ggplot(subset.rai, aes(x = Individual_Dog, y = Bobcat_RAI, group = Individual_Dog)) +
  geom_boxplot(alpha=2, fill = "cadetblue4") +
  labs(x ="Dogs", y = "Bobcat RAI") +
  theme(legend.position = "none")
ggsave("indv.dog.boxplot.lgd.png")

# Individual Dog Count using Foxlight Data
ggplot(data = rai_bobcat_lv, aes(x = Ind_Dogs, y = RAI)) +
  geom_point(aes(col=Foxlight)) +
  geom_smooth(method="loess", se=F) +
  labs(x ="Dogs", y = "Bobcat RAI")
ggsave("indv.dog.geomsmooth.foxlights.png")

ggplot(rai_bobcat_lv, aes(x = Ind_Dogs, y = RAI)) +
  geom_col(fill = "cadetblue4") +
  labs(x = "Dogs", y = "Bobcat Detections")

ggplot(data = rai_bobcat_lv, aes(x = Ind_Dogs, y = RAI, group = Ind_Dogs)) +
  geom_boxplot(alpha=2, fill = "cadetblue4") +
  labs(x ="Dogs", y = "Bobcat RAI") +
  theme(legend.position = "none")
ggsave("indv.dog.boxplot.foxlights.png")

#Plot of RAI Bobcat vs RAI LGD
ggplot(subset.rai, aes(x = Bobcat_RAI, y = Dog_RAI)) +
geom_smooth(method="lm")
ggsave("bobcat.rai.by.dog.rai.lgd.png")

ggplot(rai_bobcat_lv, aes(x = RAI, y = Dog_RAI)) +
geom_smooth(method="lm")
ggsave("bobcat.rai.by.dog.rai.foxlights.png")

#trying to make a side by side boxplot  over time
ggplot(all.rai, aes(x = Month, y = RAI)) +
geom_boxplot() +
facet_wrap(~ subset(Class == "Bobcat" & "Dog"))

```
# Diel Graph

 Question 5: Diel Patterns and Dogs
```{r q5.dailyactivity.bobcat}

record.table.lgd <- read.csv("lgd.diel.graph.record.table.no.dogs.csv")
record.table.lgd$Date <- format(as.Date(record.table.lgd$Date), "%m-%d-%Y")

# Setting up
# specify date format
record.table.lgd$Date <- as.POSIXct(record.table.lgd$Date)

# scale clock time to solar time
coords <- matrix(c(-123.079, 39.0013), nrow=1) # note it is c(longitude, latitude)
Coords <- sp::SpatialPoints(coords,
                            proj4string=sp::CRS("+proj=longlat +datum=WGS84"))
# store time as hms
record.table.lyru$Time.Corrected <- hms(record.table.lyru$Time)
# convert time from HH:MM:SS to decimal hours (HH.HHHH or whatever)
record.table.lyru$Time.Decimal <- record.table.lyru$Time.Corrected$hour + record.table.lyru$Time.Corrected$minute/60 + record.table.lyru$Time.Corrected$second/3600
# scale time so that it is between 0 and 1 by dividing by 24
record.table.lyru$Time.Scaled <- record.table.lyru$Time.Decimal / 24
# convert scaled time (0 to 1) to radians (0 to 2pi)
record.table.lyru$Time.Radians <- record.table.lyru$Time.Scaled * 2 * pi
# calculate suntime using function from overlap package, and coordinates and dates as formatted above
record.table.lyru$Time.Sun <- sunTime(record.table.lyru$Time.Radians, record.table.lyru$Date, Coords)
# plot coyote activity with and without foxlights
records.bobcat.dogyes <- subset(record.table.lyru, Species == "LYRU" & Dog_Presence == "Y")
records.bobcat.dogno <- subset(record.table.lyru, Species == "LYRU" & Dog_Presence == "N")
# define overlap function
multilines2 <-function (A, B, xscale = 24, linetype = c(1, 2), linecol = c("orange1", "cadetblue4"), n.grid = 128, kmax = 3, adjust = 1,
                        ...) 
{
  bwA <- getBandWidth(A, kmax = kmax)/adjust
  bwB <- getBandWidth(B, kmax = kmax)/adjust
  if (is.na(bwA) || is.na(bwB)) 
    stop("Bandwidth estimation failed.")
  xsc <- if (is.na(xscale))
    1
  else xscale/(2 * pi)
  xxRad <- seq(0, 2 * pi, length = n.grid)
  xx <- xxRad * xsc
  densA <- densityFit(A, xxRad, bwA)/xsc
  densB <- densityFit(B, xxRad, bwB)/xsc
  densOL <- pmin(densA, densB)
  ylim <- c(0, max(densA, densB))
  plot(0, 0, type = "n", ylim = ylim, xlim = range(xx), xlab = "Time", 
       ylab = "Relative Bobcat Activity", xaxt = "n", ...)
  if (is.na(xscale)) {
    axis(1, at = c(0, pi/2, pi, 3 * pi/2, 2 * pi), labels = c("0", 
                                                              expression(pi/2), expression(pi), expression(3 * 
                                                                                                             pi/2), expression(2 * pi)))
  }
  else if (xscale == 24) {
    axis(1, at = c(0, 6, 12, 18, 24), labels = c("Midnight", 
                                                 "Sunrise", "Noon", "Sunset", "Midnight"))
  }
  else {
    axis(1)
  }
  lines(xx, densA, lty = linetype[1], col = linecol[1], lwd = 2)
  lines(xx, densB, lty = linetype[2], col = linecol[2], lwd = 2)
  return(invisible(list(x = xx, densityA = densA, densityB = densB)))
}
watson.two.test(records.bobcat.dogyes$Time.Sun, records.bobcat.dogno$Time.Sun)
# plot bobcat activity with and without dogs
records.bobcat.dogyes <- subset(record.table.lyru, Species == "LYRU" & Dog_Presence == "Y")
records.bobcat.dogno <- subset(record.table.lyru, Species == "LYRU" & Dog_Presence == "N")
# plot for bobcats
multilines2(records.bobcat.dogyes$Time.Sun, records.bobcat.dogno$Time.Sun, main = "Bobcats w/ and w/o Dog Presence")
legend('top', c("Yes Dogs", "No Dogs"), col = c("orange1", "cadetblue4"), lty=c(1,1), bty='n')
#test significance
# this will return the degree of overlap - area under the shared curve (where 0 is completely different and 1 is completely the same)
(Dhats <- overlapEst(records.bobcat.dogyes$Time.Sun, records.bobcat.dogno$Time.Sun))
# use Dhat4 (they are different formulas - this one is good for sample sizes >50)
# then resample each one 10,000 times (bootstrapping)
bs_time.dogyes <- resample(records.bobcat.dogyes$Time.Sun, 10000)
bs_time.dogno <- resample(records.bobcat.dogno$Time.Sun, 10000)
# now calculate the resulting bootstrapped overlap value
# it should be pretty similar to the "true" value (I think it makes more sense to report the true value, with the bootstrapped confidence intervals)
bsOut <- bootEst(bs_time.dogyes, bs_time.dogno)
colMeans(bsOut) 
# now calculate the 95% confidence interval - this takes a little while to run
bs <- as.vector(bsOut[,2])
(bsCI_inout <- bootCI(Dhats[2], bs)) 
```




